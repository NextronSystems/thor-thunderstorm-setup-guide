

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3. Next Steps &mdash; THOR Thunderstorm Manual  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4. Links and References" href="links-and-references.html" />
    <link rel="prev" title="2. Install Thunderstorm Service" href="install-thunderstorm-service.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> THOR Thunderstorm Manual
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="requirements.html">1. Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="install-thunderstorm-service.html">2. Install Thunderstorm Service</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">3. Next Steps</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#configuration">3.1. Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#forward-logs-to-siem-or-analysis-cockpit">3.1.1. Forward Logs to SIEM or Analysis Cockpit</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#keep-samples-on-the-thunderstorm-server">3.1.1.1. Keep Samples on the Thunderstorm Server</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#log-output">3.2. Log Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="#thunderstorm-api-documentation">3.3. Thunderstorm API Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#test-submission">3.4. Test Submission</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#test-submission-using-the-api-documentation">3.4.1. Test Submission Using the API Documentation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#thunderstorm-collectors">3.5. Thunderstorm Collectors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#performance-considerations-for-the-collection">3.5.1. Performance Considerations for the Collection</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#thunderstorm-api-client">3.6. Thunderstorm API Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="#source-identification">3.7. Source Identification</a></li>
<li class="toctree-l2"><a class="reference internal" href="#synchronous-and-asynchronous-mode">3.8. Synchronous and Asynchronous Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#performance-tests">3.9. Performance Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ssl-tls">3.10. SSL/TLS</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="links-and-references.html">4. Links and References</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">THOR Thunderstorm Manual</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>3. Next Steps</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/usage/next-steps.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="next-steps">
<h1>3. Next Steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h1>
<p>After the installation you can test the service using one of the
Thunderstorm collectors or the Python API client.</p>
<div class="section" id="configuration">
<h2>3.1. Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>The installation script for Linux system installs a service that passes
the parameter <strong>-t /etc/thunderstorm/thunderstorm.yml</strong> to initialize
the default config stored at that location.</p>
<p>The default configuration file on Linux looks like this:</p>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><p class="first"># License path</p>
<p>license-path: /etc/thunderstorm</p>
<p># Write all outputs to the following directory</p>
<p>logfile: /var/log/thunderstorm/thunderstorm.log</p>
<p>appendlog: True</p>
<p># Listen on all possible network interfaces</p>
<p>server-host: 0.0.0.0</p>
<p>server-port: 8080</p>
<p># Pure YARA scanning</p>
<p>pure-yara: False</p>
<p># SSL/TLS</p>
<p># SSL/TLS Server Certificate</p>
<p>#server-cert: /path/to/file</p>
<p># SSL/TLS Server Certificate Private Key</p>
<p>#server-key: /path/to/file</p>
<p># File Submissions</p>
<p># Directory to which the samples get stored in asynchronous mode</p>
<p>server-upload-dir: /tmp/thunderstorm</p>
<p># Permanently store the submitted samples (valied values: none/all/malicious)</p>
<p>server-store-samples: none</p>
<p># Tuning</p>
<p># Server Result Cache</p>
<p># This is the number of cached results from asynchronous submission</p>
<p># available for remote queries (default: 10000)</p>
<p class="last">#server-result-cache-size: 10000</p>
</td>
</tr>
</tbody>
</table>
<p>You can use all of THOR’s flags in that configuration. Be advised that
you always have to use their long form.</p>
<p>This page lists all of THOR command line flags:</p>
<p><a class="reference external" href="https://github.com/NextronSystems/nextron-helper-scripts/tree/master/thor-help">https://github.com/NextronSystems/nextron-helper-scripts/tree/master/thor-help</a></p>
<p>The following chapters list some of the most useful command line flags
when using THOR Thunderstorm.</p>
<div class="section" id="forward-logs-to-siem-or-analysis-cockpit">
<h3>3.1.1. Forward Logs to SIEM or Analysis Cockpit<a class="headerlink" href="#forward-logs-to-siem-or-analysis-cockpit" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><p class="first">syslog:</p>
<ul class="last simple">
<li>mysiem.local</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Config entry to forward logs to a SIEM</p>
<p>We recommend reading chapter 16 “Syslog” in the THOR User Manual for
details on the SYSLOG forwarding flags. You can find it in the folder
/opt/nextron/thunderstorm/docs after a successful Thunderstorm
installation on Linux or in the “Downloads” section in the customer
portal.</p>
<div class="section" id="keep-samples-on-the-thunderstorm-server">
<h4>3.1.1.1. Keep Samples on the Thunderstorm Server<a class="headerlink" href="#keep-samples-on-the-thunderstorm-server" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>server-store-samples: malicious</td>
</tr>
</tbody>
</table>
<p>Keep samples with findings</p>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>server-store-samples: all</td>
</tr>
</tbody>
</table>
<p>Keep all samples</p>
</div>
</div>
</div>
<div class="section" id="log-output">
<h2>3.2. Log Output<a class="headerlink" href="#log-output" title="Permalink to this headline">¶</a></h2>
<p>The scan results and startup messages can be found in:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">thunderstorm</span><span class="o">/</span><span class="n">thunderstorm</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>You could open another command line window and monitor new messages
with:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">thunderstorm</span><span class="o">/</span><span class="n">thunderstorm</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
</div>
<div class="section" id="thunderstorm-api-documentation">
<h2>3.3. Thunderstorm API Documentation<a class="headerlink" href="#thunderstorm-api-documentation" title="Permalink to this headline">¶</a></h2>
<p>An API documentation is integrated into the web service.</p>
<p>Simply visit the service URL, e.g.: <a class="reference external" href="http://my-server:8080/">http://my-server:8080/</a></p>
<div class="figure" id="id1">
<a class="reference external image-reference" href="../_images/image5.png"><img alt="Thunderstorm API Documentation" src="../_images/image5.png" /></a>
<p class="caption"><span class="caption-text">Thunderstorm API Documentation</span></p>
</div>
</div>
<div class="section" id="test-submission">
<h2>3.4. Test Submission<a class="headerlink" href="#test-submission" title="Permalink to this headline">¶</a></h2>
<p>To test the Thunderstorm service, you can create a tiny webshell sample
and submit it to the service using the following commands.</p>
<pre class="code bash literal-block">
<span class="name builtin">echo</span> <span class="literal string double">&quot;&lt;%eval request(&quot;</span> &gt; test.txt

curl -X POST <span class="literal string double">&quot;http://0.0.0.0:8080/api/check?pretty=true&quot;</span> -F <span class="literal string double">&quot;file=&#64;test.txt&quot;</span>
</pre>
<p>This should produce the following output in the current command line.</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>  [
     {
        &quot;level&quot;: &quot;Alert&quot;,
        &quot;module&quot;: &quot;Filescan&quot;,
        &quot;message&quot;: &quot;Malware file found&quot;,
        &quot;score&quot;: 350,
        &quot;context&quot;: {
           &quot;ext&quot;: &quot;.txt&quot;,
           &quot;file&quot;: &quot;test.txt&quot;,
           &quot;firstBytes&quot;: &quot;3c256576616c2072657175657374280a / \\u003c%eval request(\\n&quot;
           &quot;md5&quot;: &quot;2481bc6bb2d063522ef8b5d579fd97d7&quot;,
           &quot;sha1&quot;: &quot;4d40de75d7c8591d2ea59d3a000fb6cf58d97896&quot;,
           &quot;sha256&quot;: &quot;3b435df5076f6b1df7f2bc97cd86fbf7b479352e8c33960dfc4f1cbbe9b14fa7&quot;,
           &quot;size&quot;: 16,
           &quot;type&quot;: &quot;JSP&quot;
    },
…
</pre></div>
</div>
<p>Output of test sample submission</p>
<p>Be aware that this has been a “synchronous” submission to the API
endpoint “check”. The collection of high amounts of samples in collector
scripts and tools uses the endpoint “checkAsync”, which doesn’t return a
result to the submitting source.</p>
<div class="section" id="test-submission-using-the-api-documentation">
<h3>3.4.1. Test Submission Using the API Documentation<a class="headerlink" href="#test-submission-using-the-api-documentation" title="Permalink to this headline">¶</a></h3>
<p>The web GUI running on Port 8080 contains an interactive API
documentation, which you can use to submit a first test sample.</p>
<div class="figure" id="id2">
<a class="reference external image-reference" href="../_images/image6.png"><img alt="Link to API Documentation on Start Page" src="../_images/image6.png" /></a>
<p class="caption"><span class="caption-text">Link to API Documentation on Start Page</span></p>
</div>
<p>Select the API function /api/check, then click “Try it out” and then
select and submit a sample using the enabled form.</p>
<div class="figure" id="id3">
<a class="reference external image-reference" href="../_images/image7.png"><img alt="Test Sample Submission via API Documentation" src="../_images/image7.png" /></a>
<p class="caption"><span class="caption-text">Test Sample Submission via API Documentation</span></p>
</div>
<p>The result appears in a separate text field. Use the “pretty” flag to
get a prettified JSON response.</p>
</div>
</div>
<div class="section" id="thunderstorm-collectors">
<h2>3.5. Thunderstorm Collectors<a class="headerlink" href="#thunderstorm-collectors" title="Permalink to this headline">¶</a></h2>
<p>You can find a Thunderstorm collector for numerous different operating
systems and architecture in our Github repository.</p>
<p><a class="reference external" href="https://github.com/NextronSystems/thunderstorm-collector">https://github.com/NextronSystems/thunderstorm-collector</a></p>
<p>See the README on Github for more information.</p>
<div class="section" id="performance-considerations-for-the-collection">
<h3>3.5.1. Performance Considerations for the Collection<a class="headerlink" href="#performance-considerations-for-the-collection" title="Permalink to this headline">¶</a></h3>
<p>In a THOR Thunderstorm setup, the system load moves from the end systems
to the Thunderstorm server.</p>
<p>In cases in which you don’t use the default configuration file provided
with the collectors (<strong>config.yml</strong>) and collect all files from an end
system, the Thunderstorm server requires a much higher amount of time to
process the samples.</p>
<p>E.g. A Thunderstorm server with 40 CPU Cores (40 threads) needs 1 hour
to process all 400,000 files sent from a Windows 10 end system. Sending
all files from 200 Windows 10 end systems to a Thunderstorm server with
that specs would take up to 10 days to process all the samples.</p>
<p>As a rule of thumb, when using the hardware recommended in a previous
chapter of this manual, calculate with a processing speed of <strong>250
samples per core per minute</strong>.</p>
<p>We highly recommend using the default configuration file named
<strong>config.yml</strong> provided with the collectors. See the README on Github
for more information.</p>
</div>
</div>
<div class="section" id="thunderstorm-api-client">
<h2>3.6. Thunderstorm API Client<a class="headerlink" href="#thunderstorm-api-client" title="Permalink to this headline">¶</a></h2>
<p>We provide a free and open source command line client written in Python
to communicate with the Thunderstorm service.</p>
<p><a class="reference external" href="https://github.com/NextronSystems/thunderstormAPI">https://github.com/NextronSystems/thunderstormAPI</a></p>
<p>It can be installed with:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">thunderstormAPI</span>
</pre></div>
</div>
</div>
<div class="section" id="source-identification">
<h2>3.7. Source Identification<a class="headerlink" href="#source-identification" title="Permalink to this headline">¶</a></h2>
<p>The log file generated by THOR Thunderstorm doesn’t contain the current
host as hostname in each line. By default, it contains the sending
source’s FQDN or IP address if a name cannot be resolved using the
locally configured DNS server.</p>
<p>However, every source can set a “source” value in the request and
overwrite the automatically evaluated hostname. This way users can use
custom values that are evaluated or set on the sending on the end
system.</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="s2">&quot;http://myserver:8080/api/check?source=test&quot;</span> <span class="o">-</span><span class="n">F</span> <span class="s2">&quot;file=@sample.exe&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="synchronous-and-asynchronous-mode">
<h2>3.8. Synchronous and Asynchronous Mode<a class="headerlink" href="#synchronous-and-asynchronous-mode" title="Permalink to this headline">¶</a></h2>
<p>It is also important to mention that THOR Thunderstorm supports two ways
to submit samples, a synchronous and an asynchronous mode.</p>
<p>The default is synchronous submission. In this mode, the sender waits
for the scan result, which can be empty in case of no detection or
contains match elements in cases in which a threat could be identified.</p>
<p>In asynchronous mode, the submitter doesn’t wait for the scan result but
always gets a send receipt with an id, which can just be discarded or
used to query the service at a later point in time. This mode is best
for use cases in which the submitter doesn’t need to know the scan
results and batch submission should be as fast as possible.</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="34%" />
<col width="38%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">&#160;</th>
<th class="head">Synchronous</th>
<th class="head">Asynchronous</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Server API Endpoint</td>
<td>/api/check</td>
<td>/api/checkAsync</td>
</tr>
<tr class="row-odd"><td>ThunderstormAPI Client Parameter</td>
<td>&#160;</td>
<td>–asyn</td>
</tr>
<tr class="row-even"><td>Advantage</td>
<td>Returns Scan Result</td>
<td>Faster Submission</td>
</tr>
<tr class="row-odd"><td>Disadvantage</td>
<td>Client waits for result of each sample</td>
<td>No immediate scan result on the client side</td>
</tr>
</tbody>
</table>
<p>In asynchronous mode, the Thunderstorm service keeps the samples in a
queue on disk and processes them one by one as soon as a thread has time
to scan them. The number of files in this queue can be queried at the
status endpoint <strong>/api/status</strong> and checked on the landing page of the
web GUI.</p>
<p>In environments in which the Thunderstorm service is used to handle
synchronous and asynchronous requests at the same time, it is possible
that all threads are busy processing cached asynchronous samples and not
more synchronous requests are possible.</p>
<p>In this case use the <strong>–sync-only-threads</strong> flag to reserve a number of
threads for synchronous requests. (e.g. <strong>–threads 40
–sync-only-threads 10</strong>)</p>
</div>
<div class="section" id="performance-tests">
<h2>3.9. Performance Tests<a class="headerlink" href="#performance-tests" title="Permalink to this headline">¶</a></h2>
<p>Performance tests showed the differences between the two submission
modes.</p>
<p>In Synchronous mode, sample transmission and server processing take
exactly the same time since the client always waits for the scan result.
In asynchronous mode, the sample transmission takes much less time, but
the processing on the server takes a bit longer, since the sever caches
the samples on disk.</p>
<table border="1" class="docutils">
<colgroup>
<col width="43%" />
<col width="28%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">&#160;</th>
<th class="head">Synchronous</th>
<th class="head">Asynchronous</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Client Transmission</td>
<td>40min</td>
<td>18min</td>
</tr>
<tr class="row-odd"><td>Server Processing</td>
<td>&#160;</td>
<td>46min</td>
</tr>
<tr class="row-even"><td>Total Time</td>
<td>40min</td>
<td>46min</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="ssl-tls">
<h2>3.10. SSL/TLS<a class="headerlink" href="#ssl-tls" title="Permalink to this headline">¶</a></h2>
<p>We do not recommend the use of SSL/TLS since it impacts the submission
performance. In cases in which you transfer files through networks with
IDS/IPS appliances, the submission in an SSL/TLS protected tunnel
prevents IDS alerts and connection resets by the IPS.</p>
<p>Depending on the average size of the samples, the submission frequency
and the number of different sources that submit samples, the
transmission could take up to twice as much time.</p>
<p>Note: The thunderstormAPI client doesn’t verify the server’s certificate
by default as in this special case, secrecy isn’t important. The main
goal of the SSL/TLS encryption is an obscured method to transport
potentially malicious samples over network segments that could be
monitored by IDS/IPS systems. You can activate certificate checks with
the <strong>–verify</strong> command line flag or <strong>verify</strong> parameter in API
library’s method respectively.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="links-and-references.html" class="btn btn-neutral float-right" title="4. Links and References" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="install-thunderstorm-service.html" class="btn btn-neutral float-left" title="2. Install Thunderstorm Service" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Nextron Systems GmbH

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>